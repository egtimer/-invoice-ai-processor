# Docker Compose configuration for Invoice AI Processor
# This file orchestrates both the backend FastAPI service and frontend React service
# Run with: docker-compose up
# Stop with: docker-compose down

version: '3.8'

services:
  # Backend FastAPI service
  backend:
    # Build from the Dockerfile in the backend directory
    build:
      context: ./backend
      dockerfile: Dockerfile
    
    # Name the container for easier identification
    container_name: invoice-ai-backend
    
    # Map port 8000 on host to port 8000 in container
    # Allows access to the API at http://localhost:8000
    ports:
      - "8000:8000"
    
    # Mount volumes to persist data and enable hot-reload during development
    volumes:
      # Persist uploaded invoices
      - ./backend/uploads:/app/uploads
      # Persist processing results
      - ./backend/results:/app/results
      # Persist logs
      - ./backend/logs:/app/logs
    
    # Environment variables for the backend
    environment:
      - PYTHONUNBUFFERED=1
      - ENVIRONMENT=production
    
    # Restart policy - always restart if container stops
    restart: unless-stopped
    
    # Health check to ensure service is running properly
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/docs"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend React/Nginx service
  frontend:
    # Build from the Dockerfile in the frontend directory
    build:
      context: ./frontend
      dockerfile: Dockerfile
      # Pass build argument for API URL
      args:
        - VITE_API_URL=http://localhost:8000
    
    # Name the container for easier identification
    container_name: invoice-ai-frontend
    
    # Map port 3000 on host to port 80 in container
    # Allows access to the web app at http://localhost:3000
    ports:
      - "3000:80"
    
    # Frontend depends on backend being available
    # Docker Compose will start backend before frontend
    depends_on:
      - backend
    
    # Restart policy - always restart if container stops
    restart: unless-stopped
    
    # Health check to ensure Nginx is serving files
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# Define a custom network for service communication
# This allows containers to communicate using service names as hostnames
networks:
  default:
    name: invoice-ai-network
    driver: bridge
